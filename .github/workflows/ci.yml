name: CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  # Fast CI job that runs on every push/PR
  test:
    name: Test & Coverage
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.25'
        cache: true

    - name: Run tests
      run: go test ./... -v -race -coverprofile=coverage.out -covermode=atomic

    - name: Display coverage
      run: |
        echo "Coverage by package:"
        go test ./pkg/format/... -cover
        go test ./pkg/sine/... -cover

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v5
      with:
        file: ./coverage.out
        flags: unittests
        name: codecov-umbrella
      continue-on-error: true

    - name: Check coverage threshold
      run: |
        COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
        echo "Total coverage: ${COVERAGE}%"
        if (( $(echo "$COVERAGE < 90.0" | bc -l) )); then
          echo "Coverage is below 90%"
          exit 1
        fi

  # Golden file tests
  golden-files:
    name: Golden File Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.25'
        cache: true

    - name: Run golden file tests
      run: go test ./pkg/sine/... -run TestGoldenFiles -v

  # Fuzz testing (quick check)
  fuzz:
    name: Fuzz Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.25'
        cache: true

    - name: Run fuzz tests (format package)
      run: |
        go test ./pkg/format/... -fuzz=FuzzPCM16_ConvertSample -fuzztime=10s
        go test ./pkg/format/... -fuzz=FuzzClamp -fuzztime=10s

    - name: Run fuzz tests (sine package)
      run: |
        go test ./pkg/sine/... -fuzz=FuzzSineGeneration -fuzztime=10s
        go test ./pkg/sine/... -fuzz=FuzzSineWriteTo -fuzztime=10s

  # Benchmark tests (performance tracking)
  benchmark:
    name: Benchmarks
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.25'
        cache: true

    - name: Run benchmarks
      run: go test ./... -bench=. -benchmem -benchtime=500ms | tee benchmark_results.txt

    - name: Store benchmark results
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-results
        path: benchmark_results.txt

    - name: Comment benchmark results on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v8
      continue-on-error: true
      with:
        script: |
          const fs = require('fs');
          const benchmarkResults = fs.readFileSync('benchmark_results.txt', 'utf8');
          const body = `## Benchmark Results\n\n\`\`\`\n${benchmarkResults}\n\`\`\``;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });

  # Lint and format check
  lint:
    name: Lint & Format
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.25'
        cache: true

    - name: golangci-lint
      uses: golangci/golangci-lint-action@v9
      with:
        version: latest
        args: --timeout=5m

    - name: Check formatting
      run: |
        if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
          echo "The following files are not formatted:"
          gofmt -s -l .
          exit 1
        fi

  # Build check
  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.25'
        cache: true

    - name: Build
      run: go build -v ./...

    - name: Build cmd
      run: go build -v -o bin/soundgen ./cmd/...

  # Matrix test across multiple Go versions
  test-matrix:
    name: Test (Go ${{ matrix.go-version }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        go-version: ['1.23', '1.24', '1.25']

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ matrix.go-version }}
        cache: true

    - name: Run tests
      run: go test ./... -v

  # Summary job that requires all checks to pass
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [test, golden-files, fuzz, benchmark, lint, build, test-matrix]
    if: always()

    steps:
    - name: Check all jobs
      run: |
        if [ "${{ needs.test.result }}" != "success" ] || \
           [ "${{ needs.golden-files.result }}" != "success" ] || \
           [ "${{ needs.fuzz.result }}" != "success" ] || \
           [ "${{ needs.benchmark.result }}" != "success" ] || \
           [ "${{ needs.lint.result }}" != "success" ] || \
           [ "${{ needs.build.result }}" != "success" ] || \
           [ "${{ needs.test-matrix.result }}" != "success" ]; then
          echo "One or more jobs failed"
          exit 1
        fi
        echo "All CI jobs passed!"
